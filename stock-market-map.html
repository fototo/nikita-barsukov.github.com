<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>

<title>Making treemaps in R and JavaScript.</title>
<link href='http://fonts.googleapis.com/css?family=Quattrocento' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Droid+Sans' rel='stylesheet' type='text/css'>

<style type="text/css">
h1, h2, h3 {
  font-family: 'Quattrocento', serif;
}
body {
  font-family: 'Droid Sans', sans-serif;
}
table{
  border-collapse:collapse;
}
th {
  border-bottom: 1px solid black;
}
caption {
  margin-bottom: 10px;
}

#main{
  width: 900px ;
  margin-left: auto ;
  margin-right: auto ;
}

.node {
  border: solid 1px black;
  font: 10px sans-serif;
  color: black;
  line-height: 12px;
  overflow: hidden;
  position: absolute;
  text-indent: 2px;
}

#chart {
    width: 960px;
    position: relative;    
}

</style>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-2.0.0.min.js"></script>
<script src="colorbrewer.js"></script>
</head>

<body>
<div id="main">
  <h1>Making treemaps in R and JavaScript.</h1>

  <p>Treemap is an interesting way to visualize hierarchical data. There were several great examples of such type of visualizations, such as New York times visualization of Obama&#39;s latest <a href="http://www.nytimes.com/packages/html/newsgraphics/2011/0119-budget/">budget proposal</a>, or <a href="http://www.smartmoney.com/map-of-the-market/">map of the market</a> by Smart Money magazine.</p>

  <p>This is a treemap visualization, using data in CSV file. This is different from an example on D3.js example galelry, since it is required to convert CSV data into a hierarchical JSON tree object for further treemap visualization. Source code is on <a href="https://github.com/nikita-barsukov/nikita-barsukov.github.com/blob/master/stock-market-map.html">github</a>.</p>

  <p>References:
    <ol>
      <li><a href="http://bl.ocks.org/mbostock/4063582">Treemap example from D3.js examples</a> </li>
      <li><a href="http://stackoverflow.com/questions/11088303/how-to-convert-to-d3s-json-format">Stack Overflow question about converting CSV to JSON tree </a></li>
      <li><a href="https://dl.dropbox.com/s/fkfmvjgk5e8x4uq/treemap-nasdaq.csv">Market data as of 9<sup>th</sup> of May 2014 in CSV format</a></li>
    </ol>

  <div id='chart'>
    <h2>NASDAQ stock market map for 9<sup>th</sup> of May 2013</h2>
  <script>

  var margin = {top: 40, right: 10, bottom: 10, left: 10},
      width = 960 - margin.left - margin.right,
      height = 500 - margin.top - margin.bottom; 

   var treemap = d3.layout.treemap()
      .size([width, height])
      .sticky(true)
      .value(function(d) { return d.volume; }); // specifying what variable is tied to tile area

  var color = d3.scale.quantile()
      .domain([-55, 0, 25])
      .range(colorbrewer["RdBu"][11]);
    
  var div = d3.select("div#chart").append("div")
      .style("position", "relative")
      .style("width", (width + margin.left + margin.right) + "px")
      .style("height", (height + margin.top + margin.bottom) + "px")
      .style("left", margin.left + "px")
      .style("top", margin.top + "px");

  d3.csv("raw_logs/treemap-nasdaq.csv",function(rows) {
    var stock_market_tree = {"name": "stock_map","children": []};
    var nodesD3 = {};
    rows.forEach(function(row) {
      var parent_d3 = d3_node(row.sector);
      var child_d3 = {"name": row.name, "symbol": row.symbol, "change":+row.change, "volume":+row.volume};

      if (parent_d3.children) parent_d3.children.push(child_d3);
      else parent_d3.children = [child_d3]; 
    });
    temp_d3 = []
    for (var key in nodesD3) {
      if (nodesD3.hasOwnProperty(key)) {
        temp_d3.push(nodesD3[key])
      }
    }

    stock_market_tree["children"] = temp_d3;

    var node = div.selectAll(".node")
      .data(treemap.nodes(stock_market_tree))
    .enter().append("div")
      .attr("class", "node")
      .call(position)
      .style("background-color", function(d) { return d.children ? null : color(d.change) ; }) // color only nodes without children to avoid color overlapping
      .text(function(d) { return (d.children || Math.max(0, d.dx - 1) < 35) ? null : d.symbol; }); // put stock symbol only to wide squares

    function d3_node(name) {
      return nodesD3[name] || (nodesD3[name] = {name: name});
    }
  });

  function position() {
    this.style("left", function(d) { return d.x + "px"; })
        .style("top", function(d) { return d.y + "px"; })
        .style("width", function(d) { return Math.max(0, d.dx - 1) + "px"; })
        .style("height", function(d) { return Math.max(0, d.dy - 1) + "px"; });
  }

  </script>

  </div>
</div>
</body>

</html>

